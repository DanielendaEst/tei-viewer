# Apache configuration for TEI Viewer
# Place this in /etc/apache2/sites-available/tei-viewer.conf
# Then enable with: sudo a2ensite tei-viewer

<VirtualHost *:80>
    # Replace with your domain name
    ServerName tei-viewer.example.com
    ServerAdmin admin@example.com

    # Document root - point to the dist folder
    DocumentRoot /var/www/tei-viewer/dist

    # Logging
    ErrorLog ${APACHE_LOG_DIR}/tei-viewer-error.log
    CustomLog ${APACHE_LOG_DIR}/tei-viewer-access.log combined

    # Directory configuration
    <Directory /var/www/tei-viewer/dist>
        Options -Indexes +FollowSymLinks
        AllowOverride All
        Require all granted

        # Enable SPA routing - redirect all to index.html
        RewriteEngine On
        RewriteBase /
        RewriteRule ^index\.html$ - [L]
        RewriteCond %{REQUEST_FILENAME} !-f
        RewriteCond %{REQUEST_FILENAME} !-d
        RewriteRule . /index.html [L]
    </Directory>

    # WASM MIME type - CRITICAL for WebAssembly
    AddType application/wasm .wasm

    # Security headers
    Header always set X-Frame-Options "SAMEORIGIN"
    Header always set X-Content-Type-Options "nosniff"
    Header always set X-XSS-Protection "1; mode=block"

    # WASM requires specific headers
    Header always set Cross-Origin-Opener-Policy "same-origin"
    Header always set Cross-Origin-Embedder-Policy "require-corp"

    # Enable compression
    <IfModule mod_deflate.c>
        AddOutputFilterByType DEFLATE text/html text/plain text/xml text/css
        AddOutputFilterByType DEFLATE application/javascript application/json
        AddOutputFilterByType DEFLATE application/wasm
    </IfModule>

    # Cache static assets
    <IfModule mod_expires.c>
        ExpiresActive On
        ExpiresByType application/wasm "access plus 1 year"
        ExpiresByType application/javascript "access plus 1 year"
        ExpiresByType text/css "access plus 1 year"
        ExpiresByType image/png "access plus 1 year"
        ExpiresByType image/jpeg "access plus 1 year"
        ExpiresByType image/jpg "access plus 1 year"
        ExpiresByType image/gif "access plus 1 year"
        ExpiresByType image/svg+xml "access plus 1 year"
    </IfModule>

</VirtualHost>

# SSL/HTTPS configuration (recommended for production)
# Uncomment and configure after obtaining SSL certificate with certbot
#
# <IfModule mod_ssl.c>
# <VirtualHost *:443>
#     ServerName tei-viewer.example.com
#     ServerAdmin admin@example.com
#
#     DocumentRoot /var/www/tei-viewer/dist
#
#     # SSL certificate paths (managed by certbot)
#     SSLEngine on
#     SSLCertificateFile /etc/letsencrypt/live/tei-viewer.example.com/fullchain.pem
#     SSLCertificateKeyFile /etc/letsencrypt/live/tei-viewer.example.com/privkey.pem
#
#     # SSL configuration
#     SSLProtocol all -SSLv2 -SSLv3 -TLSv1 -TLSv1.1
#     SSLCipherSuite HIGH:!aNULL:!MD5
#     SSLHonorCipherOrder on
#
#     # Rest of configuration same as above
#     <Directory /var/www/tei-viewer/dist>
#         Options -Indexes +FollowSymLinks
#         AllowOverride All
#         Require all granted
#
#         RewriteEngine On
#         RewriteBase /
#         RewriteRule ^index\.html$ - [L]
#         RewriteCond %{REQUEST_FILENAME} !-f
#         RewriteCond %{REQUEST_FILENAME} !-d
#         RewriteRule . /index.html [L]
#     </Directory>
#
#     # Include all other directives from HTTP config above
# </VirtualHost>
# </IfModule>
#
# # Redirect HTTP to HTTPS
# <VirtualHost *:80>
#     ServerName tei-viewer.example.com
#     Redirect permanent / https://tei-viewer.example.com/
# </VirtualHost>

# Required Apache modules:
# sudo a2enmod rewrite
# sudo a2enmod headers
# sudo a2enmod expires
# sudo a2enmod deflate
# sudo a2enmod ssl (for HTTPS)
